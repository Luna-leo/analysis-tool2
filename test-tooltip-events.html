<!DOCTYPE html>
<html>
<head>
    <title>D3.js Event Test</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 10px;
            border-radius: 4px;
            font-size: 12px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .tooltip.pinned {
            pointer-events: auto;
            border: 1px solid #666;
        }
        
        svg {
            border: 1px solid #ccc;
        }
        
        circle {
            cursor: pointer;
        }
    </style>
</head>
<body>
    <h2>D3.js Click Event Test</h2>
    <div id="chart"></div>
    
    <script>
        // Create SVG
        const svg = d3.select("#chart")
            .append("svg")
            .attr("width", 400)
            .attr("height", 300);
        
        // Create tooltip
        let tooltip = null;
        let pinnedTooltip = null;
        
        function showTooltip(event, content, isPinned = false) {
            // Remove existing tooltip if not pinned
            if (!isPinned && tooltip) {
                tooltip.remove();
                tooltip = null;
            }
            
            const newTooltip = d3.select("body")
                .append("div")
                .attr("class", isPinned ? "tooltip pinned" : "tooltip")
                .html(content)
                .style("left", (event.pageX + 10) + "px")
                .style("top", (event.pageY - 10) + "px");
            
            newTooltip.transition()
                .duration(200)
                .style("opacity", 1);
            
            if (isPinned) {
                pinnedTooltip = newTooltip;
            } else {
                tooltip = newTooltip;
            }
            
            return newTooltip;
        }
        
        function togglePinnedTooltip(event, content) {
            event.stopPropagation();
            
            if (pinnedTooltip) {
                pinnedTooltip.remove();
                pinnedTooltip = null;
            } else {
                if (tooltip) {
                    tooltip.remove();
                    tooltip = null;
                }
                showTooltip(event, content, true);
            }
        }
        
        // Create test data
        const data = [
            { x: 50, y: 50, label: "Point 1" },
            { x: 150, y: 100, label: "Point 2" },
            { x: 250, y: 75, label: "Point 3" },
            { x: 350, y: 150, label: "Point 4" }
        ];
        
        // Add circles
        svg.selectAll("circle")
            .data(data)
            .enter()
            .append("circle")
            .attr("cx", d => d.x)
            .attr("cy", d => d.y)
            .attr("r", 8)
            .style("fill", "steelblue")
            .style("stroke", "navy")
            .style("stroke-width", 1)
            .style("opacity", 0.7)
            .on("mouseover", function(event, d) {
                console.log("Mouseover:", d.label);
                d3.select(this)
                    .style("opacity", 1)
                    .style("stroke-width", 2);
            })
            .on("mouseout", function(event, d) {
                console.log("Mouseout:", d.label);
                d3.select(this)
                    .style("opacity", 0.7)
                    .style("stroke-width", 1);
            })
            .on("click", function(event, d) {
                console.log("Click event fired for:", d.label);
                console.log("Event details:", event);
                const content = `<strong>${d.label}</strong><br>X: ${d.x}<br>Y: ${d.y}`;
                togglePinnedTooltip(event, content);
            });
        
        // Add click handler to SVG to close tooltips
        svg.on("click", function(event) {
            console.log("SVG clicked");
            if (event.target === this) {
                if (pinnedTooltip) {
                    pinnedTooltip.remove();
                    pinnedTooltip = null;
                }
                if (tooltip) {
                    tooltip.remove();
                    tooltip = null;
                }
            }
        });
        
        // Log D3 version
        console.log("D3 version:", d3.version);
    </script>
</body>
</html>